# ================================
# AutoVoiceCollation Docker Compose
# ================================

services:
  # API 服务
  autovoicecollation-api:
    image: autovoicecollation:latest
    container_name: avc-api
    build:
      context: .
      dockerfile: Dockerfile

    # 端口映射（主机端口:容器端口）
    ports:
      - "8000:8000"

      # 使用主机网络模式（Windows 不支持，仅作备选）
      # network_mode: "host"

      # 环境变量配置
    # 方式1: 直接在这里配置
    environment:
        - CHINESE_FONT_PATH=/usr/share/fonts/truetype/wqy/wqy-zenhei.ttc
        - ZIP_OUTPUT_ENABLED=true

    # 方式2: 使用 .env 文件（推荐）
    env_file:
      - .env

    # 卷挂载：持久化数据和缓存
    volumes:
      # 输出目录
      - ./out:/app/out
      # 下载目录
      - ./download:/app/download
      # 临时文件目录
      - ./temp:/app/temp
      # 日志目录
      - ./logs:/app/logs
      # 模型缓存目录（加速启动）
      - ./models:/app/models
      # 如果需要修改配置，可以挂载 .env 文件
      # - ./.env:/app/.env

    # GPU 支持（需要安装 nvidia-docker）
    deploy:
      resources:
        limits:
          memory: 8G  # 限制最大内存使用 8GB（根据实际情况调整）
        reservations:
          memory: 4G  # 预留 4GB 内存
          devices:
            - driver: nvidia
              count: all  # 使用所有 GPU
              capabilities: [ gpu ]

    # 重启策略
    restart: unless-stopped

    # 健康检查（首次启动模型加载可能需要较长时间）
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8000/health || exit 0" ]  # 允许失败
      interval: 30s
      timeout: 10s
      retries: 10  # 增加重试次数
      start_period: 180s  # 增加到 3 分钟等待模型加载

    # 网络模式
    networks:
      - avc-network

    # 仅当显式启动 GPU 版本时使用
    profiles:
      - gpu

  # 仅 CPU 版本（不需要 GPU）
  autovoicecollation-api-cpu:
    image: autovoicecollation:cpu
    container_name: avc-api-cpu
    build:
      context: .
      dockerfile: Dockerfile.cpu

    ports:
      - "8001:8000"

    env_file:
      - .env

    volumes:
      - ./out:/app/out
      - ./download:/app/download
      - ./temp:/app/temp
      - ./logs:/app/logs
      - ./models:/app/models

    # CPU 版本资源限制
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4'  # 限制 CPU 核心数
        reservations:
          memory: 4G

    restart: unless-stopped

    # 健康检查
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8000/health || exit 0" ]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s

    # 禁用此服务（如果不需要 CPU 版本）
    profiles:
      - cpu-only

networks:
  avc-network:
    driver: bridge
